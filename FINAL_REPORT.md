# 메이플스토리 아이템 시세 예측 - 최종 보고서

**프로젝트명**: MapleStory Meso Market Price Prediction  
**작성일**: 2025년 12월 16일  
**데이터셋**: 메이플스토리 경매장 거래 기록 2,629,909건

---

## 1. 문제 정의

### 1.1 배경

메이플스토리는 대표적인 MMORPG(대규모 다중 사용자 온라인 롤플레잉 게임)로, 게임 내 아이템은 상당한 경제적 가치를 지닙니다. 게임에는 플레이어들이 "메소"라는 게임 내 화폐를 사용하여 아이템을 사고 팔 수 있는 경매장 시스템이 있습니다. 아이템 가격은 50 메소에서 약 2조 메소(1,999,999,999,999)까지 **10자리 이상의 범위**를 가지며 매우 다양합니다.

### 1.2 문제 정의

**목표**: 아이템의 속성을 기반으로 메이플스토리 경매장에서 아이템 가격을 정확하게 예측하는 머신러닝 모델 개발

**입력 데이터**: 다음을 포함한 아이템 속성:
- 기본 속성 (이름, item_id, 카테고리)
- 강화 속성 (스타포스, 주문서 작)
- 잠재능력 옵션 (잠재능력 등급, % 스탯 옵션)
- 에디셔널 옵션 (추가옵션 등급, 추가옵션 내용)
- 스탯 보너스 (STR, DEX, INT, LUK, 공격력 등)
- 시간 특징 (거래 날짜, 요일)

**출력**: 메소 단위의 예측 가격

### 1.3 주요 도전 과제

1. **극단적인 가격 범위**: 50 메소에서 ~2조 메소까지 (10자리 이상의 차이)
2. **복잡한 중첩 데이터**: 아이템 속성이 깊게 중첩된 JSON 구조로 저장됨
3. **높은 카디널리티 특징**: 수천 개의 고유한 아이템 이름과 ID
4. **복잡한 가격 결정 요인**: 스타포스, 잠재능력, 주문서 작, 아이템 종류 간의 복잡한 상호작용
5. **시장 변동성**: 게임 업데이트, 이벤트, 플레이어 수요에 따른 가격 변동

### 1.4 성공 지표

- **R² (결정계수)**: 모델이 가격 분산을 얼마나 잘 설명하는지 측정
- **RMSE (평균 제곱근 오차)**: 큰 예측 오차에 페널티 부여
- **MAE (평균 절대 오차)**: 평균 절대 예측 오차
- **MAPE (평균 절대 백분율 오차)**: 상대적 예측 오차 (넓은 가격 범위에서 중요)

---

## 2. 적용 방법론 설명

### 2.1 데이터 처리 파이프라인

#### 2.1.1 데이터 추출
- **소스**: 2,629,909건의 경매 거래 기록이 포함된 JSONL 파일
- **형식**: 각 레코드에 중첩된 JSON 필드 포함 (`payload_json`, `detail_json`, `summary_json`)

#### 2.1.2 특징 엔지니어링

**A. 기본 특징 추출 (69개 특징)**
- 중첩된 JSON 구조 파싱
- star_force, potential_grade, additional_grade 추출
- 스탯 배열 (STR, DEX, INT, LUK) 합계 및 최대값 집계
- 퍼센트 스탯 (데미지%, 보스 데미지%, 방무%) 추출
- 시간 특징 (년, 월, 일, 요일, 시간)

**B. 개선된 특징 추출 (총 134개 특징)**

이번 개선에서 추가된 새로운 특징:

1. **상세 잠재능력 옵션 파싱**
   - "STR +6%" 형태의 옵션에서 수치 값 추출
   - 생성된 특징: `pot_str_percent`, `pot_dex_percent`, `pot_int_percent`, `pot_luk_percent`
   - 조합 스탯: `pot_total_percent_value`, `pot_total_main_stat_percent`

2. **아이템 메타데이터 추출**
   - `category`: 아이템 카테고리 (신발, 상의, 장갑 등)
   - `level_requirement`: 착용 레벨 제한
   - `job_type`: 직업군 제한 (전사, 마법사 등)
   - `star_force_max`: 최대 스타포스 가능 수치
   - `item_grade`: 아이템 등급

3. **복합 특징**
   - `enhancement_score`: 스타포스, 주문서 작, 등급의 조합 점수
   - `potential_value_score`: 잠재능력 스탯의 가중치 조합
   - `value_score`: 공격력, 등급, 스타포스의 정규화된 조합
   - `star_force_ratio`: 현재 스타포스 / 최대 스타포스
   - `combined_main_stat_percent`: 잠재능력 + 에디셔널의 총 주스탯 %

4. **지표 특징**
   - `is_high_star`: 스타포스 >= 17인 경우 1
   - `is_legendary_potential`: 레전드리 잠재능력인 경우 1
   - `is_unique_or_higher`: 유니크 이상 잠재능력인 경우 1

### 2.2 타겟 변수 변환

**로그 변환 (log1p)**

극단적인 가격 범위(50 ~ 2조)로 인해 log1p 변환을 적용:
- 원본: `y = price` (범위: 50 ~ 1,999,999,999,999)
- 변환 후: `y = log(1 + price)` (범위: 3.93 ~ 28.32)

장점:
- 타겟 분포 정규화
- 상대적 가격 차이 학습에 도움
- MAPE (평균 절대 백분율 오차) 크게 개선

### 2.3 모델 아키텍처

#### 2.3.1 LightGBM (그래디언트 부스팅)

RandomizedSearchCV로 튜닝된 하이퍼파라미터를 사용한 LightGBM 프레임워크 적용:

| 파라미터 | 값 |
|----------|-----|
| n_estimators | 300 |
| max_depth | 7 |
| learning_rate | 0.1 |
| num_leaves | 31 |
| feature_fraction | 0.9 |
| bagging_fraction | 0.8 |
| bagging_freq | 7 |
| min_child_samples | 10 |
| reg_alpha | 0.1 |
| reg_lambda | 1.0 |

**LightGBM 선택 이유**
- 높은 카디널리티 범주형 특징 처리에 우수
- 대용량 데이터셋(260만 샘플) 빠른 학습
- 결측값 내장 처리
- 혼합 특징 유형의 테이블 데이터에 탁월

#### 2.3.2 학습 설정

- **훈련/검증/테스트 분할**: 70% / 10% / 20%
- **샘플 수**: 훈련 1,840,936 / 검증 262,991 / 테스트 525,982
- **조기 종료**: 검증 세트에서 20 라운드
- **목적 함수**: RMSE (로그 변환된 타겟 기준)

### 2.4 모델 비교

네 가지 접근법 비교:

1. **기준 Random Forest**: 기본 특징을 사용한 초기 모델
2. **LightGBM (기본)**: 로그 변환 없는 LightGBM
3. **앙상블 (RF + LightGBM)**: 가중치 앙상블 (RF 30% + LightGBM 70%)
4. **개선된 모델**: 강화된 특징 + 로그 변환

---

## 3. 최종 결과 및 해석

### 3.1 성능 지표 비교

| 모델 | 테스트 R² | 테스트 RMSE | 테스트 MAE | 테스트 MAPE |
|------|-----------|-------------|------------|-------------|
| Random Forest (기준) | 0.6270 | 6,388억 | 5.33억 | - |
| LightGBM (기본) | 0.7401 | 4,489억 | 5.26억 | 34,241% |
| 앙상블 (RF+LGB) | 0.8034 | 3,904억 | 5.92억 | 31,286% |
| **개선된 모델** | **0.7885** | **4,113억** | **4.27억** | **354%** |

### 3.2 주요 결과 분석

#### 3.2.1 MAE 개선 (+27.8%)
- **이전**: 평균 5.92억 메소 오차
- **이후**: 평균 4.27억 메소 오차
- 모델이 평균적으로 **1.65억 메소 더 정확**해짐

#### 3.2.2 MAPE 획기적 개선 (-98.9%)
- **이전**: 31,286% (상대적 예측에 실질적으로 사용 불가)
- **이후**: 354% (가격 비교에 의미 있는 수준)
- 로그 변환으로 모델이 **상대적** 가격 차이를 학습하여 대폭 개선

#### 3.2.3 R² 점수
- **개선된 모델**: 0.7885 (가격 분산의 약 79% 설명)
- **로그 스케일 R²**: 0.9691 (로그 가격 분산의 약 97% 설명)
- 높은 로그 스케일 R²는 상대적 가격 패턴의 우수한 학습을 나타냄

### 3.3 특징 중요도 분석

**Top 15 중요 특징:**

| 순위 | 특징 | 중요도 | 해석 |
|------|------|--------|------|
| 1 | name | 759 | 아이템 이름이 주요 가격 결정 요인 |
| 2 | day_of_year | 501 | 시간적 패턴 (이벤트, 업데이트) |
| 3 | item_id | 441 | 특정 아이템 유형 식별 |
| 4 | value_score | 435 | 복합 품질 지표 |
| 5 | job_type | 403 | 직업별 아이템 수요 차이 |
| 6 | detail_percent_StatR_sum | 300 | 총 스탯 % 보너스 |
| 7 | day | 288 | 월별 일자 패턴 |
| 8 | detail_cuttable | 262 | 교환의 가위 사용 가능 횟수 |
| 9 | level_requirement | 260 | 높은 레벨 = 고티어 아이템 |
| 10 | max_stat | 218 | 최대 단일 스탯 보너스 |
| 11 | enhancement_score | 193 | 종합 강화 레벨 |
| 12 | pot_total_percent_value | 184 | 잠재능력 총 % 수치 |
| 13 | total_percent_stat | 176 | 전체 % 스탯 보너스 |
| 14 | detail_PDD_max | 166 | 최대 방어력 스탯 |
| 15 | potential_grade | 158 | 잠재능력 등급 |

**인사이트:**
- **아이템 정체성이 가장 중요**: `name`과 `item_id`가 압도적. 아이템마다 기본 가치가 크게 다름
- **시간 특징이 유의미**: 게임 이벤트와 업데이트에 따른 시장 가격 변동
- **직업 유형이 중요**: 직업별 아이템(전사, 마법사 등)의 수요 패턴 차이
- **강화 지표**: 주문서 작, 스타포스, 잠재능력을 포착하는 여러 특징이 기여
- **새 특징이 효과적**: `value_score`, `enhancement_score`, `pot_total_percent_value` (신규 추가) 상위 랭크

### 3.4 예측 예시

모델 성능을 설명하는 일반적인 예측 시나리오:

| 가격 범위 | 일반적 오차 | 사용 사례 |
|-----------|-------------|-----------|
| < 1억 메소 | ~5천만~1억 | 저티어 아이템, 소모품 |
| 1억 ~ 10억 | ~2~4억 | 중티어 장비 |
| 10억 ~ 100억 | ~5~10억 | 고티어 장비 |
| > 100억 | ~10~20억 | 엔드게임 최고 스펙 |

---

## 4. 향후 연구/개발 가능성 논의

### 4.1 단기 개선 (1-2주)

#### 4.1.1 특징 엔지니어링 확장
- **텍스트 임베딩**: NLP 기법으로 아이템 이름과 옵션 텍스트 인코딩
- **과거 가격 특징**: 유사 아이템의 이동 평균, 가격 추세
- **시장 공급 특징**: 현재 등록된 유사 아이템 수

#### 4.1.2 모델 개선
- **가격 구간 분리**: 다른 가격 범위에 대해 별도 모델 학습
  - 저가 (< 1억): 정밀도 중심
  - 고가 (> 100억): 상대적 정확도 중심
- **분위수 회귀**: 점 추정 대신 가격 범위 예측
- **스태킹 앙상블**: 모델 예측을 메타 학습기의 특징으로 활용

### 4.2 중기 개선 (1-3개월)

#### 4.2.1 고급 모델
- **CatBoost**: 범주형 특징 처리 개선
- **TabNet**: 어텐션 메커니즘을 가진 테이블 데이터용 딥러닝
- **임베딩 신경망**: 거래 패턴에서 아이템 임베딩 학습

#### 4.2.2 시계열 요소
- **LSTM/GRU 통합**: 가격 변화의 시간적 패턴 포착
- **계절성 분해**: 주간/월간 패턴 명시적 모델링
- **이벤트 감지**: 게임 업데이트의 가격 영향 식별 및 모델링

#### 4.2.3 데이터 강화
- **웹 스크래핑**: 외부 데이터 통합 (패치 노트, 이벤트 일정)
- **플레이어 활동 데이터**: 서버 인구, 활성 거래자
- **유사 아이템 비교**: 비교 가능한 아이템 대비 상대 가격

### 4.3 장기 개발 (3-6개월)

#### 4.3.1 프로덕션 시스템
- **실시간 예측 API**: 즉시 가격 추정을 위한 REST API
- **가격 알림 시스템**: 아이템이 저평가/고평가될 때 사용자 알림
- **자동 모델 재학습**: 시장 변화를 포착하기 위한 주간 업데이트

#### 4.3.2 고급 응용
- **가격 차익 탐지**: 거래용 저평가 아이템 식별
- **투자 추천**: 가치 상승 가능성 있는 아이템 제안
- **시장 트렌드 분석**: 시장 건전성 모니터링 대시보드

#### 4.3.3 연구 방향
- **인과 추론**: 실제로 가격 변화를 일으키는 요인 이해
- **이상 탐지**: 비정상 거래 식별 (잠재적 사기/복제)
- **다중 서버 분석**: 다른 게임 서버 간 가격 비교

### 4.4 한계 및 고려사항

1. **시장 조작**: 가격이 인위적으로 부풀려지거나 낮춰질 수 있음
2. **게임 업데이트**: 주요 패치가 과거 패턴을 무효화할 수 있음
3. **플레이어 행동**: 개별 판매자의 비합리적 가격 책정
4. **데이터 신선도**: 정기적인 재학습 없이는 모델 성능 저하

---

## 5. 결론

이 프로젝트는 다음 성과를 달성하며 메이플스토리 아이템 가격 예측 머신러닝 모델을 성공적으로 개발했습니다:

### 주요 성과:
1. **강화된 특징 엔지니어링**: 69개에서 134개 특징으로 확장, 상세 잠재능력 파싱 포함
2. **로그 변환**: MAPE를 31,286%에서 354%로 획기적 개선
3. **MAE 개선**: 평균 오차 27.8% 감소 (1.65억 메소)
4. **해석 가능한 결과**: 명확한 특징 중요도 분석으로 가격 결정 요인 파악

### 모델 성능:
- **R² 점수**: 0.7885 (79% 분산 설명)
- **로그 스케일 R²**: 0.9691 (97% 로그 가격 분산)
- **MAE**: 4.27억 메소
- **MAPE**: 354%

### 실용적 가치:
이 모델은 다음에 대해 의미 있는 가격 추정을 제공할 수 있습니다:
- 구매/판매 시 가격 검증
- 시장 분석 및 트렌드 식별
- 거래 결정을 위한 아이템 평가

극단적인 가격 이상치 처리에 개선의 여지가 있지만, 현재 모델은 자동화된 게임 아이템 평가에서 상당한 발전을 나타냅니다.

---

## 부록

### A. 기술 스택
- **언어**: Python 3.10
- **ML 프레임워크**: LightGBM 4.0+
- **데이터 처리**: Pandas, NumPy
- **모델 저장**: Joblib

### B. 파일 구조
```
maple-meso/
├── README.md                        # 프로젝트 문서
├── FINAL_REPORT.md                  # 본 보고서
├── requirements.txt                 # Python 의존성
├── data/
│   ├── raw/raw_data.jsonl           # 원본 거래 데이터 (260만 건)
│   └── processed/preprocessed_data.parquet  # 전처리된 데이터
├── models/
│   ├── improved/                    # 최신 모델 (권장)
│   │   ├── model.joblib             # 학습된 LightGBM 모델
│   │   ├── scaler.joblib            # 특징 스케일러
│   │   ├── label_encoders.joblib    # 레이블 인코더
│   │   ├── feature_importance.json  # 특징 중요도 점수
│   │   └── metrics.json             # 성능 지표
│   ├── archive/                     # 이전 버전 모델
│   └── hyperparameter_tuning_results.json
├── src/
│   ├── preprocess.py                # 데이터 전처리 (134개 특징)
│   ├── train.py                     # 모델 학습 모듈
│   ├── train_improved.py            # 개선된 학습 파이프라인
│   └── predict.py                   # 예측 인터페이스
├── docs/                            # 문서
│   ├── PROGRESS_REPORT.md
│   └── colab/                       # Google Colab 파일
└── logs/                            # 학습 로그
```

### C. 재현 방법
결과를 재현하려면:
```bash
cd maple-meso
pip install -r requirements.txt
python -m src.train_improved --save-dir models
```

학습된 모델로 예측하려면:
```bash
python src/predict.py --interactive
```

---

**보고서 작성**: ML 파이프라인  
**작성일**: 2025년 12월 16일  
**학습 소요 시간**: 260만 샘플 기준 약 21분
